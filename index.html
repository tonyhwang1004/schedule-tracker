<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¹€ì—„ë§ˆë…ì„œì‹¤ ì¼ì •í‘œ ì œì¶œ í˜„í™©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ì„¤ì • - ì—¬ê¸°ì„œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì •ë³´ ë³€ê²½
    const CONFIG = {
      SPREADSHEET_ID: '1OVEffnCRTZ1A-cVCb4CYiYe3MicyI9TSkJNsau4mGVo',
      SHEET_GIDS: { floor7: '141026233', floor8: '1949498498' }
    };

    function App() {
      const [submissionData, setSubmissionData] = useState(null);
      const [rosterData, setRosterData] = useState(null);
      const [activeTab, setActiveTab] = useState('notSubmitted');
      const [searchTerm, setSearchTerm] = useState('');
      const [floorFilter, setFloorFilter] = useState('all');
      const [copiedName, setCopiedName] = useState(null);
      const [copiedAll, setCopiedAll] = useState(false);
      const [loading, setLoading] = useState(false);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [error, setError] = useState(null);
      const [autoRefresh, setAutoRefresh] = useState(true);
      const [refreshInterval, setRefreshInterval] = useState(30);

      const parseCSV = (csvText) => {
        const lines = csvText.split('\n');
        if (lines.length === 0) return [];
        
        const parseRow = (line) => {
          const result = [];
          let current = '';
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
            else current += char;
          }
          result.push(current.trim());
          return result;
        };

        const headers = parseRow(lines[0]);
        return lines.slice(1).filter(l => l.trim()).map(line => {
          const values = parseRow(line);
          const row = {};
          headers.forEach((h, i) => row[h] = values[i] || '');
          return row;
        });
      };

      const formatPhone = (phone) => {
        if (!phone) return null;
        const c = phone.toString().replace(/\D/g, '');
        if (c.length === 10) return `010-${c.slice(1,5)}-${c.slice(5)}`;
        if (c.length === 11) return `${c.slice(0,3)}-${c.slice(3,7)}-${c.slice(7)}`;
        return phone;
      };

      const loadData = useCallback(async (silent = false) => {
        if (!silent) setLoading(true);
        setError(null);
        
        try {
          const fetchSheet = async (gid) => {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`);
            if (!res.ok) throw new Error('ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨');
            return parseCSV(await res.text());
          };

          const processStudents = (data) => data
            .filter(row => {
              const name = Object.values(row)[0];
              return name && name.length > 1 && name.length < 10 && !name.includes('í•™ìƒ');
            })
            .map(row => {
              const values = Object.values(row);
              const keys = Object.keys(row);
              return {
                name: values[0]?.trim(),
                phone: formatPhone(values[keys.findIndex(k => k.includes('í•™ìƒ ì „í™”'))]),
                parentPhone: formatPhone(values[keys.findIndex(k => k.includes('í•™ë¶€ëª¨'))])
              };
            })
            .filter(s => s.name && s.name.length > 1);

          const data7 = await fetchSheet(CONFIG.SHEET_GIDS.floor7);
          let data8 = [];
          try { data8 = await fetchSheet(CONFIG.SHEET_GIDS.floor8); } catch(e) {}

          setRosterData({ floor7: processStudents(data7), floor8: processStudents(data8) });
          setLastUpdated(new Date());
        } catch (err) {
          setError(err.message);
        } finally {
          if (!silent) setLoading(false);
        }
      }, []);

      useEffect(() => { loadData(); }, []);
      
      useEffect(() => {
        if (!autoRefresh) return;
        const interval = setInterval(() => loadData(true), refreshInterval * 1000);
        return () => clearInterval(interval);
      }, [autoRefresh, refreshInterval, loadData]);

      const processFile = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          const wb = XLSX.read(evt.target.result, { type: 'array' });
          const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          const categorized = { submitted: [], parentApproved: [], supervisorApproved: [] };
          data.forEach(row => {
            const name = row['ì´ë¦„']?.toString().trim();
            const status = row['ìŠ¹ì¸ìƒíƒœ']?.toString().trim();
            if (!name) return;
            const student = { name, status };
            if (status === 'ì œì¶œ ë‹¨ê³„') categorized.submitted.push(student);
            else if (status === 'í•™ë¶€ëª¨ ìŠ¹ì¸ ì™„ë£Œ') categorized.parentApproved.push(student);
            else if (status === 'ì‚¬ê° ìŠ¹ì¸ ì™„ë£Œ') categorized.supervisorApproved.push(student);
          });
          setSubmissionData(categorized);
        };
        reader.readAsArrayBuffer(file);
      };

      // ê°œë³„ ì´ë¦„ ë³µì‚¬
      const copyName = async (name) => {
        await navigator.clipboard.writeText(name);
        setCopiedName(name);
        setTimeout(() => setCopiedName(null), 1500);
      };

      // ì „ì²´ ì´ë¦„ ë³µì‚¬ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)
      const copyAllNames = async (students) => {
        const names = students.map(s => s.name).join('\n');
        await navigator.clipboard.writeText(names);
        setCopiedAll(true);
        setTimeout(() => setCopiedAll(false), 2000);
      };

      const result = useMemo(() => {
        if (!submissionData || !rosterData) return null;
        const submitted = new Set([
          ...submissionData.submitted.map(s => s.name),
          ...submissionData.parentApproved.map(s => s.name),
          ...submissionData.supervisorApproved.map(s => s.name)
        ]);
        const notSubmitted8 = rosterData.floor8.filter(s => !submitted.has(s.name));
        const notSubmitted7 = rosterData.floor7.filter(s => !submitted.has(s.name));
        return {
          notSubmitted: { floor8: notSubmitted8, floor7: notSubmitted7 },
          stats: {
            total8: rosterData.floor8.length, total7: rosterData.floor7.length,
            notSubmitted8: notSubmitted8.length, notSubmitted7: notSubmitted7.length,
            submitted8: rosterData.floor8.length - notSubmitted8.length,
            submitted7: rosterData.floor7.length - notSubmitted7.length,
            submittedStage: submissionData.submitted.length,
            parentApproved: submissionData.parentApproved.length,
            supervisorApproved: submissionData.supervisorApproved.length
          }
        };
      }, [submissionData, rosterData]);

      const filter = (students) => students?.filter(s => !searchTerm || s.name.includes(searchTerm)) || [];

      const StudentCard = ({ student, color }) => {
        const colors = {
          red: 'bg-red-50 border-red-200 text-red-800 hover:bg-red-100',
          yellow: 'bg-yellow-50 border-yellow-200 text-yellow-800 hover:bg-yellow-100',
          blue: 'bg-blue-50 border-blue-200 text-blue-800 hover:bg-blue-100',
          green: 'bg-green-50 border-green-200 text-green-800 hover:bg-green-100'
        };
        const isCopied = copiedName === student.name;
        return (
          <div 
            onClick={() => copyName(student.name)}
            className={`px-3 py-2 rounded-lg border ${colors[color]} text-sm cursor-pointer transition-all ${isCopied ? 'ring-2 ring-blue-400' : ''}`}
          >
            <div className="font-medium flex items-center gap-1">
              {student.name}
              {isCopied && <span className="text-xs text-blue-500">âœ“ë³µì‚¬ë¨</span>}
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-4">
              <h1 className="text-2xl font-bold text-slate-800 mb-1">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤ ì¼ì •í‘œ ì œì¶œ í˜„í™©</h1>
              <p className="text-slate-500 text-sm">ì‹¤ì‹œê°„ Google Sheets ì—°ë™</p>
            </div>

            {/* ìƒíƒœë°” */}
            <div className="bg-white rounded-xl shadow-sm border p-3 mb-4">
              <div className="flex flex-wrap items-center justify-between gap-3">
                <div className="flex items-center gap-3">
                  <span className={`px-2 py-1 rounded-full text-xs ${autoRefresh ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                    {autoRefresh ? 'ğŸŸ¢ ì‹¤ì‹œê°„' : 'âšª ìˆ˜ë™'}
                  </span>
                  {lastUpdated && <span className="text-xs text-slate-400">{lastUpdated.toLocaleTimeString('ko-KR')}</span>}
                  {loading && <span className="text-blue-500">â³</span>}
                </div>
                <div className="flex items-center gap-2">
                  <select value={refreshInterval} onChange={e => setRefreshInterval(+e.target.value)} className="text-xs border rounded px-2 py-1">
                    <option value={10}>10ì´ˆ</option>
                    <option value={30}>30ì´ˆ</option>
                    <option value={60}>1ë¶„</option>
                  </select>
                  <button onClick={() => setAutoRefresh(!autoRefresh)} className={`text-xs px-3 py-1 rounded-lg ${autoRefresh ? 'bg-green-500 text-white' : 'bg-slate-200'}`}>
                    {autoRefresh ? 'ìë™' : 'ìˆ˜ë™'}
                  </button>
                  <button onClick={() => loadData()} className="px-2 py-1 bg-blue-500 text-white rounded-lg text-xs">ğŸ”„</button>
                </div>
              </div>
              {error && <div className="mt-2 text-xs text-red-500">{error}</div>}
            </div>

            {/* íŒŒì¼ ì—…ë¡œë“œ */}
            <div className="grid md:grid-cols-2 gap-3 mb-4">
              <div className={`p-3 border-2 rounded-xl ${rosterData ? 'border-green-400 bg-green-50' : 'border-slate-200'}`}>
                <span className="text-sm">{rosterData ? `âœ… í•™ìƒëª…ë‹¨ (7ì¸µ ${rosterData.floor7.length}ëª…, 8ì¸µ ${rosterData.floor8.length}ëª…)` : 'â³ ë¡œë”©ì¤‘...'}</span>
              </div>
              <label className={`p-3 border-2 border-dashed rounded-xl cursor-pointer ${submissionData ? 'border-green-400 bg-green-50' : 'border-slate-300 hover:border-blue-400'}`}>
                <span className="text-sm">{submissionData ? `âœ… ìˆ˜ëŠ¥ì„ ë°°.xlsx (${submissionData.submitted.length + submissionData.parentApproved.length + submissionData.supervisorApproved.length}ëª…)` : 'ğŸ“ ìˆ˜ëŠ¥ì„ ë°°.xlsx ì—…ë¡œë“œ'}</span>
                <input type="file" accept=".xlsx,.xls" className="hidden" onChange={processFile} />
              </label>
            </div>

            {/* ê²°ê³¼ */}
            {result && (
              <>
                {/* í†µê³„ */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                  <div className="bg-white p-3 rounded-xl shadow-sm border">
                    <div className="text-xs text-slate-500 mb-1">ğŸ¢ 8ì¸µ</div>
                    <div className="text-xl font-bold">{result.stats.submitted8}/{result.stats.total8}</div>
                    <div className="text-xs text-red-500">ë¯¸ì œì¶œ {result.stats.notSubmitted8}ëª…</div>
                  </div>
                  <div className="bg-white p-3 rounded-xl shadow-sm border">
                    <div className="text-xs text-slate-500 mb-1">ğŸ¢ 7ì¸µ</div>
                    <div className="text-xl font-bold">{result.stats.submitted7}/{result.stats.total7}</div>
                    <div className="text-xs text-red-500">ë¯¸ì œì¶œ {result.stats.notSubmitted7}ëª…</div>
                  </div>
                  <div className="bg-white p-3 rounded-xl shadow-sm border">
                    <div className="text-xs text-yellow-600 mb-1">â³ ìŠ¹ì¸ëŒ€ê¸°</div>
                    <div className="text-xl font-bold text-yellow-600">{result.stats.submittedStage + result.stats.parentApproved}ëª…</div>
                  </div>
                  <div className="bg-white p-3 rounded-xl shadow-sm border">
                    <div className="text-xs text-green-600 mb-1">âœ… ì™„ë£Œ</div>
                    <div className="text-xl font-bold text-green-600">{result.stats.supervisorApproved}ëª…</div>
                  </div>
                </div>

                {/* ê²€ìƒ‰/í•„í„° */}
                <div className="flex flex-wrap gap-2 mb-3">
                  <input type="text" placeholder="ğŸ” í•™ìƒ ê²€ìƒ‰..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                    className="flex-1 min-w-40 px-3 py-2 text-sm border rounded-lg" />
                  <div className="flex gap-1 bg-slate-100 p-1 rounded-lg">
                    {['all', '8', '7'].map(f => (
                      <button key={f} onClick={() => setFloorFilter(f)}
                        className={`px-3 py-1 rounded text-xs font-medium ${floorFilter === f ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>
                        {f === 'all' ? 'ì „ì²´' : f + 'ì¸µ'}
                      </button>
                    ))}
                  </div>
                </div>

                {/* íƒ­ */}
                <div className="flex gap-1 mb-3 overflow-x-auto">
                  {[
                    { id: 'notSubmitted', label: 'ğŸ”´ ë¯¸ì œì¶œ', count: result.stats.notSubmitted8 + result.stats.notSubmitted7 },
                    { id: 'submitted', label: 'ğŸŸ¡ ì œì¶œë‹¨ê³„', count: result.stats.submittedStage },
                    { id: 'parentApproved', label: 'ğŸ”µ í•™ë¶€ëª¨ìŠ¹ì¸', count: result.stats.parentApproved },
                    { id: 'supervisorApproved', label: 'ğŸŸ¢ ì‚¬ê°ìŠ¹ì¸', count: result.stats.supervisorApproved }
                  ].map(tab => (
                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                      className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap ${activeTab === tab.id ? 'bg-white shadow' : 'bg-slate-100'}`}>
                      {tab.label} <span className="bg-slate-200 px-1.5 py-0.5 rounded-full">{tab.count}</span>
                    </button>
                  ))}
                </div>

                {/* í•™ìƒ ëª©ë¡ */}
                <div className="bg-white rounded-xl shadow-sm border p-4">
                  {activeTab === 'notSubmitted' && (
                    <div>
                      <div className="flex items-center justify-between mb-3 pb-2 border-b">
                        <span className="text-sm font-semibold">ğŸ”´ ë¯¸ì œì¶œ í•™ìƒ (í´ë¦­í•˜ë©´ ì´ë¦„ ë³µì‚¬)</span>
                        <button 
                          onClick={() => {
                            const all = [];
                            if (floorFilter !== '7') all.push(...filter(result.notSubmitted.floor8));
                            if (floorFilter !== '8') all.push(...filter(result.notSubmitted.floor7));
                            copyAllNames(all);
                          }}
                          className={`text-xs px-3 py-1 rounded-lg transition-all ${copiedAll ? 'bg-green-500 text-white' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
                        >
                          {copiedAll ? 'âœ“ ë³µì‚¬ì™„ë£Œ!' : 'ğŸ“‹ ì „ì²´ì´ë¦„ ë³µì‚¬'}
                        </button>
                      </div>
                      {floorFilter !== '7' && result.notSubmitted.floor8.length > 0 && (
                        <div className="mb-3">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-xs text-slate-500">8ì¸µ ({filter(result.notSubmitted.floor8).length}ëª…)</span>
                            <button 
                              onClick={() => copyAllNames(filter(result.notSubmitted.floor8))}
                              className="text-xs text-blue-500 hover:underline"
                            >
                              8ì¸µë§Œ ë³µì‚¬
                            </button>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {filter(result.notSubmitted.floor8).map((s, i) => <StudentCard key={i} student={s} color="red" />)}
                          </div>
                        </div>
                      )}
                      {floorFilter !== '8' && result.notSubmitted.floor7.length > 0 && (
                        <div>
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-xs text-slate-500">7ì¸µ ({filter(result.notSubmitted.floor7).length}ëª…)</span>
                            <button 
                              onClick={() => copyAllNames(filter(result.notSubmitted.floor7))}
                              className="text-xs text-blue-500 hover:underline"
                            >
                              7ì¸µë§Œ ë³µì‚¬
                            </button>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {filter(result.notSubmitted.floor7).map((s, i) => <StudentCard key={i} student={s} color="red" />)}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                  {activeTab === 'submitted' && (
                    <div>
                      <div className="flex items-center justify-between mb-3 pb-2 border-b">
                        <span className="text-sm font-semibold">ğŸŸ¡ ì œì¶œ ë‹¨ê³„ (í•™ë¶€ëª¨ ìŠ¹ì¸ ëŒ€ê¸°)</span>
                        <button 
                          onClick={() => copyAllNames(filter(submissionData.submitted))}
                          className={`text-xs px-3 py-1 rounded-lg ${copiedAll ? 'bg-green-500 text-white' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
                        >
                          {copiedAll ? 'âœ“ ë³µì‚¬ì™„ë£Œ!' : 'ğŸ“‹ ì „ì²´ì´ë¦„ ë³µì‚¬'}
                        </button>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {filter(submissionData.submitted).map((s, i) => <StudentCard key={i} student={s} color="yellow" />)}
                      </div>
                    </div>
                  )}
                  {activeTab === 'parentApproved' && (
                    <div>
                      <div className="flex items-center justify-between mb-3 pb-2 border-b">
                        <span className="text-sm font-semibold">ğŸ”µ í•™ë¶€ëª¨ ìŠ¹ì¸ ì™„ë£Œ (ì‚¬ê° ìŠ¹ì¸ ëŒ€ê¸°)</span>
                        <button 
                          onClick={() => copyAllNames(filter(submissionData.parentApproved))}
                          className={`text-xs px-3 py-1 rounded-lg ${copiedAll ? 'bg-green-500 text-white' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
                        >
                          {copiedAll ? 'âœ“ ë³µì‚¬ì™„ë£Œ!' : 'ğŸ“‹ ì „ì²´ì´ë¦„ ë³µì‚¬'}
                        </button>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {filter(submissionData.parentApproved).map((s, i) => <StudentCard key={i} student={s} color="blue" />)}
                      </div>
                    </div>
                  )}
                  {activeTab === 'supervisorApproved' && (
                    <div>
                      <div className="flex items-center justify-between mb-3 pb-2 border-b">
                        <span className="text-sm font-semibold">ğŸŸ¢ ì‚¬ê° ìŠ¹ì¸ ì™„ë£Œ âœ“</span>
                        <button 
                          onClick={() => copyAllNames(filter(submissionData.supervisorApproved))}
                          className={`text-xs px-3 py-1 rounded-lg ${copiedAll ? 'bg-green-500 text-white' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
                        >
                          {copiedAll ? 'âœ“ ë³µì‚¬ì™„ë£Œ!' : 'ğŸ“‹ ì „ì²´ì´ë¦„ ë³µì‚¬'}
                        </button>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {filter(submissionData.supervisorApproved).map((s, i) => <StudentCard key={i} student={s} color="green" />)}
                      </div>
                    </div>
                  )}
                </div>
              </>
            )}

            {!result && (
              <div className="text-center py-8 bg-white rounded-xl border text-slate-400">
                {loading ? 'â³ ë¡œë”©ì¤‘...' : rosterData ? 'ğŸ“ ìˆ˜ëŠ¥ì„ ë°°.xlsxë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”' : 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'}
              </div>
            )}

            <div className="mt-4 text-center">
              <a href={`https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/edit`} target="_blank" className="text-xs text-blue-500 hover:underline">
                ğŸ“Š Google Sheets ì›ë³¸ ë³´ê¸°
              </a>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
