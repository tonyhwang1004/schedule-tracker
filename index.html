<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì •ê¸°ì¼ì • ì œì¶œ í˜„í™©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; }
    .present { box-shadow: 0 0 0 3px #22c55e; }
    .seat-num { font-size: 0.7rem; color: #6b7280; margin-right: 2px; }
    .seat-focus { font-size: 0.7rem; color: #8b5cf6; margin-right: 2px; font-weight: 600; }
    .seat-free { font-size: 0.7rem; color: #f97316; margin-right: 2px; font-weight: 600; }
    .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #ddd; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-2">ğŸ“š ì •ê¸°ì¼ì • ì œì¶œ í˜„í™©</h1>
    <p class="text-center text-slate-500 text-sm mb-6">Google Sheets ì‹¤ì‹œê°„ ì—°ë™</p>

    <!-- ìƒíƒœë°” -->
    <div class="bg-white rounded-xl p-3 mb-4 flex flex-wrap items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <span id="status" class="text-sm text-slate-500">â³ ë¡œë”©ì¤‘...</span>
      </div>
      <button onclick="loadGoogleSheets()" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
      <!-- ìˆ˜ëŠ¥ì„ ë°° ì—…ë¡œë“œ -->
      <label id="uploadBox" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-blue-400">
        <div class="text-base mb-1">ğŸ“ ìˆ˜ëŠ¥ì„ ë°°</div>
        <div class="text-xs text-slate-500">ì œì¶œ í˜„í™©</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadSubmission(this)">
      </label>

      <!-- 8ì¸µ ì¶œì„ ì—…ë¡œë“œ -->
      <label id="upload8" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-green-400">
        <div class="text-base mb-1">ğŸ¢ 8ì¸µ ì¶œì„</div>
        <div class="text-xs text-slate-500">ì¶œì… ê¸°ë¡</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 8)">
      </label>

      <!-- 7ì¸µ ì¶œì„ ì—…ë¡œë“œ -->
      <label id="upload7" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-green-400">
        <div class="text-base mb-1">ğŸ¢ 7ì¸µ ì¶œì„</div>
        <div class="text-xs text-slate-500">ì¶œì… ê¸°ë¡</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 7)">
      </label>

      <!-- ì§‘ì¤‘ì‹¤ ì¢Œì„ ì—…ë¡œë“œ -->
      <label id="uploadFocus" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-purple-400">
        <div class="text-base mb-1">ğŸ¯ ì§‘ì¤‘ì‹¤</div>
        <div class="text-xs text-slate-500">ì¢Œì„ ë°°ì¹˜</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadFocusRoom(this)">
      </label>
    </div>

    <!-- ììœ ì„ ì¢Œì„ ì—…ë¡œë“œ (PDF/ì´ë¯¸ì§€ ìë™ ë¶„ì„) -->
    <div class="mb-6">
      <label id="uploadFree" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-orange-400">
        <div class="text-base mb-1">ğŸª‘ 8ì¸µ ììœ ì„ ë°°ì¹˜ë„</div>
        <div class="text-xs text-slate-500">PDF ë˜ëŠ” ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìë™ ë¶„ì„)</div>
        <input type="file" accept=".pdf,image/*" class="hidden" onchange="loadFreeSeat(this)">
      </label>
      <div id="freeSeatStatus" class="mt-2 text-sm text-center"></div>
      <div id="freeSeatResult" class="mt-2"></div>
    </div>

    <!-- ë²”ë¡€ -->
    <div class="flex flex-wrap items-center gap-4 mb-4 text-sm text-slate-600">
      <span class="flex items-center gap-1"><span class="w-4 h-4 rounded border-2 border-green-500 bg-green-100"></span> í˜„ì¬ ìˆìŒ</span>
      <span class="flex items-center gap-1"><span class="text-gray-400 text-xs">ë‚˜ê°</span> = í‡´ì‹¤</span>
      <span class="flex items-center gap-1"><span class="text-gray-500 text-xs">[ë²ˆí˜¸]</span> = ì§€ì •ì„</span>
      <span class="flex items-center gap-1"><span class="text-orange-500 text-xs font-bold">[ë²ˆí˜¸]</span> = ììœ ì„</span>
      <span class="flex items-center gap-1"><span class="text-purple-500 text-xs font-bold">[ì§‘ì¤‘N]</span> = ì§‘ì¤‘ì‹¤</span>
    </div>

    <!-- ê²°ê³¼ -->
    <div id="result"></div>
  </div>

  <script>
    // ì„¤ì •
    const SPREADSHEET_ID = '1OVEffnCRTZ1A-cVCb4CYiYe3MicyI9TSkJNsau4mGVo';
    const SHEET_GIDS = { floor7: '141026233', floor8: '910829726' };

    // ë°ì´í„°
    let roster = { floor7: [], floor8: [] };
    let seatMap = { floor7: {}, floor8: {} }; // Google Sheetsì—ì„œ ë¡œë“œ
    let focusRoomSeats = {}; // ì§‘ì¤‘ì‹¤ ì¢Œì„ (ì—‘ì…€ì—ì„œ ë¡œë“œ)
    let freeSeatMap = {}; // ììœ ì„ ì¢Œì„ (PDF ë¶„ì„ ë°ì´í„°)
    let freeSeatImage = null; // ììœ ì„ ì´ë¯¸ì§€
    let submission = { submitted: [], parentApproved: [], supervisorApproved: [] };
    let attendance = { floor7: { present: [], exited: [] }, floor8: { present: [], exited: [] } };
    let copiedText = '';

    // ììœ ì„ ì´ˆê¸° ë°ì´í„° (PDF ì—…ë¡œë“œ ì‹œ ìë™ ë¶„ì„ë¨)
    freeSeatMap = {};

    // ì¢Œì„ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    function getSeatNumber(name, floor) {
      // ì§‘ì¤‘ì‹¤ ë¨¼ì € ì²´í¬
      if (focusRoomSeats[name]) {
        return 'ì§‘ì¤‘' + focusRoomSeats[name];
      }
      // ììœ ì„ ì²´í¬ (8ì¸µë§Œ)
      if (floor === 8 && freeSeatMap[name]) {
        return freeSeatMap[name];
      }
      // Google Sheets ë°ì´í„°
      const map = floor === 7 ? seatMap.floor7 : seatMap.floor8;
      return map[name] || null;
    }

    // ì§‘ì¤‘ì‹¤ ì—‘ì…€ ë¡œë“œ
    function loadFocusRoom(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
        
        focusRoomSeats = {};
        
        // í—¤ë” ìŠ¤í‚µí•˜ê³  ë°ì´í„° íŒŒì‹±
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (!row || row.length < 2) continue;
          
          // Aì—´: ì´ë¦„, Bì—´: ì¢Œì„ë²ˆí˜¸ (ë˜ëŠ” ë‹¤ë¥¸ êµ¬ì¡°ì¼ ìˆ˜ ìˆìŒ)
          const name = (row[0] || '').toString().trim();
          const seat = (row[1] || '').toString().trim();
          
          if (name && /^[ê°€-í£]{2,4}$/.test(name) && seat) {
            const seatNum = seat.match(/\d+/);
            if (seatNum) {
              focusRoomSeats[name] = parseInt(seatNum[0]);
            }
          }
        }

        const count = Object.keys(focusRoomSeats).length;
        document.getElementById('uploadFocus').className = 'block p-3 border-2 border-purple-400 rounded-xl cursor-pointer text-center bg-purple-50';
        document.getElementById('uploadFocus').innerHTML = `
          <div class="text-base mb-1">âœ… ì§‘ì¤‘ì‹¤</div>
          <div class="text-xs text-purple-600">${count}ëª… ë°°ì¹˜</div>
          <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadFocusRoom(this)">
        `;
        
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    // ììœ ì„ PDF/ì´ë¯¸ì§€ ìë™ ë¶„ì„
    async function loadFreeSeat(input) {
      const file = input.files[0];
      if (!file) return;

      const statusEl = document.getElementById('freeSeatStatus');
      const resultEl = document.getElementById('freeSeatResult');
      
      statusEl.innerHTML = '<span class="loading-spinner"></span> ë¶„ì„ ì¤‘...';
      resultEl.innerHTML = '';

      try {
        let text = '';
        
        if (file.type === 'application/pdf') {
          // PDF ë¶„ì„
          text = await extractTextFromPDF(file);
        } else {
          // ì´ë¯¸ì§€ëŠ” ì•„ì§ ì§€ì› ì•ˆë¨ (Tesseract.js í•„ìš” - ìš©ëŸ‰ì´ í¼)
          statusEl.innerHTML = '<span class="text-orange-500">âš ï¸ ì´ë¯¸ì§€ ë¶„ì„ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. PDFë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</span>';
          return;
        }

        // í…ìŠ¤íŠ¸ì—ì„œ ì´ë¦„-ì¢Œì„ë²ˆí˜¸ íŒŒì‹±
        const parsed = parseFreeSeatText(text);
        
        if (Object.keys(parsed).length > 0) {
          freeSeatMap = parsed;
          
          document.getElementById('uploadFree').className = 'block p-3 border-2 border-orange-400 rounded-xl cursor-pointer text-center bg-orange-50';
          document.getElementById('uploadFree').innerHTML = `
            <div class="text-base mb-1">âœ… 8ì¸µ ììœ ì„ ë°°ì¹˜ë„</div>
            <div class="text-xs text-orange-600">${Object.keys(parsed).length}ëª… ìë™ ë¶„ì„ ì™„ë£Œ</div>
            <input type="file" accept=".pdf,image/*" class="hidden" onchange="loadFreeSeat(this)">
          `;
          
          statusEl.innerHTML = `<span class="text-green-600">âœ… ${Object.keys(parsed).length}ëª… ì¢Œì„ ë¶„ì„ ì™„ë£Œ!</span>`;
          
          // ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
          resultEl.innerHTML = `
            <div class="bg-orange-50 rounded-lg p-3 text-sm">
              <div class="font-bold mb-2 text-orange-700">ğŸª‘ ììœ ì„ ë°°ì¹˜ (ë¶„ì„ ê²°ê³¼)</div>
              <div class="flex flex-wrap gap-2">
                ${Object.entries(parsed).sort((a,b) => a[1] - b[1]).map(([name, seat]) => 
                  `<span class="px-2 py-1 bg-white rounded border text-xs">[${seat}] ${name}</span>`
                ).join('')}
              </div>
            </div>
          `;
          
          render();
        } else {
          statusEl.innerHTML = '<span class="text-red-500">âŒ ì¢Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
        }
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="text-red-500">âŒ ë¶„ì„ ì‹¤íŒ¨: ${err.message}</span>`;
      }
    }

    // PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
    async function extractTextFromPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      
      return fullText;
    }

    // ììœ ì„ í…ìŠ¤íŠ¸ íŒŒì‹± (ì´ë¦„-ì¢Œì„ë²ˆí˜¸ ì¶”ì¶œ)
    function parseFreeSeatText(text) {
      const result = {};
      
      // í•œê¸€ ì´ë¦„ íŒ¨í„´ (2-4ê¸€ì + ì„ íƒì  ìˆ«ì)
      const namePattern = /[ê°€-í£]{2,4}\d*/g;
      // ìˆ«ì íŒ¨í„´ (ì¢Œì„ë²ˆí˜¸: ì£¼ë¡œ 57-104 ë²”ìœ„)
      const numberPattern = /\b(\d{2,3})\b/g;
      
      // í…ìŠ¤íŠ¸ë¥¼ ë¼ì¸ë³„ë¡œ ë¶„ì„
      const lines = text.split(/\s+/);
      
      // ìˆ«ìì™€ ì´ë¦„ì´ ì¸ì ‘í•œ íŒ¨í„´ ì°¾ê¸°
      for (let i = 0; i < lines.length; i++) {
        const item = lines[i].trim();
        
        // ìˆ«ìì¸ ê²½ìš°
        if (/^\d{2,3}$/.test(item)) {
          const seatNum = parseInt(item);
          
          // ììœ ì„ ë²”ìœ„ ì²´í¬ (57-104)
          if (seatNum >= 57 && seatNum <= 104) {
            // ë‹¤ìŒ ì•„ì´í…œì´ ì´ë¦„ì¸ì§€ í™•ì¸
            if (i + 1 < lines.length) {
              const nextItem = lines[i + 1].trim();
              if (/^[ê°€-í£]{2,4}\d*$/.test(nextItem)) {
                result[nextItem] = seatNum;
              }
            }
            // ì´ì „ ì•„ì´í…œì´ ì´ë¦„ì¸ì§€ë„ í™•ì¸
            if (i > 0) {
              const prevItem = lines[i - 1].trim();
              if (/^[ê°€-í£]{2,4}\d*$/.test(prevItem) && !result[prevItem]) {
                result[prevItem] = seatNum;
              }
            }
          }
        }
        
        // ì´ë¦„ì¸ ê²½ìš° (í•œê¸€ 2-4ì + ì„ íƒì  ìˆ«ì)
        if (/^[ê°€-í£]{2,4}\d*$/.test(item)) {
          // ë‹¤ìŒ ì•„ì´í…œì´ ìˆ«ìì¸ì§€ í™•ì¸
          if (i + 1 < lines.length) {
            const nextItem = lines[i + 1].trim();
            if (/^\d{2,3}$/.test(nextItem)) {
              const seatNum = parseInt(nextItem);
              if (seatNum >= 57 && seatNum <= 104) {
                result[item] = seatNum;
              }
            }
          }
          // ì´ì „ ì•„ì´í…œì´ ìˆ«ìì¸ì§€ë„ í™•ì¸
          if (i > 0 && !result[item]) {
            const prevItem = lines[i - 1].trim();
            if (/^\d{2,3}$/.test(prevItem)) {
              const seatNum = parseInt(prevItem);
              if (seatNum >= 57 && seatNum <= 104) {
                result[item] = seatNum;
              }
            }
          }
        }
      }
      
      return result;
    }

    // Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì´ë¦„ + ì¢Œì„ë²ˆí˜¸)
    async function loadGoogleSheets() {
      document.getElementById('status').textContent = 'â³ ë¡œë”©ì¤‘...';
      
      try {
        // 7ì¸µ ë°ì´í„°
        const res7 = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GIDS.floor7}`);
        const csv7 = await res7.text();
        const data7 = parseNamesAndSeats(csv7);
        roster.floor7 = data7.names;
        seatMap.floor7 = data7.seats;

        // 8ì¸µ ë°ì´í„°
        const res8 = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GIDS.floor8}`);
        const csv8 = await res8.text();
        const data8 = parseNamesAndSeats(csv8);
        roster.floor8 = data8.names;
        seatMap.floor8 = data8.seats;

        const now = new Date().toLocaleTimeString('ko-KR');
        document.getElementById('status').innerHTML = `âœ… 7ì¸µ ${roster.floor7.length}ëª…, 8ì¸µ ${roster.floor8.length}ëª… <span class="text-slate-400 text-xs">(${now})</span>`;
        
        render();
      } catch(e) {
        document.getElementById('status').textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
      }
    }

    // CSVì—ì„œ ì´ë¦„(Aì—´)ê³¼ ì¢Œì„ë²ˆí˜¸(Eì—´) ì¶”ì¶œ
    function parseNamesAndSeats(csv) {
      const lines = csv.split('\n');
      const names = [];
      const seats = {};
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        // CSV íŒŒì‹±
        const cols = parseCSVRow(line);
        const name = (cols[0] || '').replace(/"/g, '').trim();
        const seatRaw = (cols[4] || '').replace(/"/g, '').trim(); // Eì—´ (ì¸ë±ìŠ¤ 4)
        
        // ìœ íš¨í•œ ì´ë¦„ì¸ì§€ í™•ì¸
        if (name && /^[ê°€-í£]{2,4}$/.test(name) && !name.includes('í•™ìƒ') && !name.includes('ì´ë¦„')) {
          names.push(name);
          
          // ì¢Œì„ë²ˆí˜¸ ì¶”ì¶œ (ìˆ«ìë§Œ)
          const seatMatch = seatRaw.match(/^(\d+)/);
          if (seatMatch) {
            seats[name] = parseInt(seatMatch[1]);
          }
        }
      }
      
      return { names, seats };
    }

    // CSV í–‰ íŒŒì‹± (ë”°ì˜´í‘œ ì²˜ë¦¬)
    function parseCSVRow(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // ìˆ˜ëŠ¥ì„ ë°°.xlsx íŒŒì¼ ë¡œë“œ
    function loadSubmission(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        
        submission = { submitted: [], parentApproved: [], supervisorApproved: [] };
        
        data.forEach(row => {
          const name = row['ì´ë¦„']?.toString().trim();
          const status = row['ìŠ¹ì¸ìƒíƒœ']?.toString().trim();
          if (!name || !status) return;
          
          if (status === 'ì œì¶œ ë‹¨ê³„') submission.submitted.push(name);
          else if (status === 'í•™ë¶€ëª¨ ìŠ¹ì¸ ì™„ë£Œ') submission.parentApproved.push(name);
          else if (status === 'ì‚¬ê° ìŠ¹ì¸ ì™„ë£Œ') submission.supervisorApproved.push(name);
        });

        document.getElementById('uploadBox').className = 'block p-3 border-2 border-green-400 rounded-xl cursor-pointer text-center bg-green-50';
        document.getElementById('uploadBox').innerHTML = `
          <div class="text-base mb-1">âœ… ìˆ˜ëŠ¥ì„ ë°°.xlsx</div>
          <div class="text-xs text-slate-500">${submission.submitted.length + submission.parentApproved.length + submission.supervisorApproved.length}ëª… ì œì¶œ</div>
          <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadSubmission(this)">
        `;
        
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    // ì¶œì„ íŒŒì¼ ë¡œë“œ
    function loadAttendance(input, floor) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        
        const lastRecord = {};
        data.forEach(row => {
          const name = row['ì´ë¦„']?.toString().trim();
          const direction = row['ë°©í–¥']?.toString().trim();
          if (name && direction && !lastRecord[name]) {
            lastRecord[name] = direction;
          }
        });
        
        const presentStudents = Object.keys(lastRecord).filter(name => lastRecord[name] === 'ENTER');
        const exitedStudents = Object.keys(lastRecord).filter(name => lastRecord[name] === 'EXIT');
        
        if (floor === 7) {
          attendance.floor7 = { present: presentStudents, exited: exitedStudents };
          document.getElementById('upload7').className = 'block p-3 border-2 border-green-400 rounded-xl cursor-pointer text-center bg-green-50';
          document.getElementById('upload7').innerHTML = `
            <div class="text-base mb-1">âœ… 7ì¸µ ì¶œì„</div>
            <div class="text-xs text-slate-500">${presentStudents.length}ëª… ìˆìŒ / ${exitedStudents.length}ëª… ë‚˜ê°</div>
            <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 7)">
          `;
        } else {
          attendance.floor8 = { present: presentStudents, exited: exitedStudents };
          document.getElementById('upload8').className = 'block p-3 border-2 border-green-400 rounded-xl cursor-pointer text-center bg-green-50';
          document.getElementById('upload8').innerHTML = `
            <div class="text-base mb-1">âœ… 8ì¸µ ì¶œì„</div>
            <div class="text-xs text-slate-500">${presentStudents.length}ëª… ìˆìŒ / ${exitedStudents.length}ëª… ë‚˜ê°</div>
            <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 8)">
          `;
        }
        
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    // ì´ë¦„ ë³µì‚¬
    function copyName(name) {
      navigator.clipboard.writeText(name);
      copiedText = name;
      render();
      setTimeout(() => { copiedText = ''; render(); }, 1500);
    }

    // ì „ì²´ ì´ë¦„ ë³µì‚¬
    function copyAll(names) {
      navigator.clipboard.writeText(names.join('\n'));
      alert(`${names.length}ëª… ì´ë¦„ ë³µì‚¬ ì™„ë£Œ!`);
    }

    // í™”ë©´ ë Œë”ë§
    function render() {
      const resultDiv = document.getElementById('result');
      
      if (roster.floor7.length === 0 && roster.floor8.length === 0) {
        resultDiv.innerHTML = '';
        return;
      }

      if (submission.submitted.length === 0 && submission.parentApproved.length === 0 && submission.supervisorApproved.length === 0) {
        resultDiv.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-slate-400">ìˆ˜ëŠ¥ì„ ë°°.xlsx íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>';
        return;
      }

      const allSubmitted = new Set([...submission.submitted, ...submission.parentApproved, ...submission.supervisorApproved]);

      const data = {
        floor8: {
          notSubmitted: roster.floor8.filter(n => !allSubmitted.has(n)),
          submitted: roster.floor8.filter(n => submission.submitted.includes(n)),
          parentApproved: roster.floor8.filter(n => submission.parentApproved.includes(n)),
          supervisorApproved: roster.floor8.filter(n => submission.supervisorApproved.includes(n))
        },
        floor7: {
          notSubmitted: roster.floor7.filter(n => !allSubmitted.has(n)),
          submitted: roster.floor7.filter(n => submission.submitted.includes(n)),
          parentApproved: roster.floor7.filter(n => submission.parentApproved.includes(n)),
          supervisorApproved: roster.floor7.filter(n => submission.supervisorApproved.includes(n))
        }
      };

      resultDiv.innerHTML = `
        <!-- 8ì¸µ -->
        <div class="bg-white rounded-xl p-4 mb-4">
          <h2 class="text-lg font-bold mb-4">ğŸ¢ 8ì¸µ (ì´ ${roster.floor8.length}ëª…) ${attendance.floor8.present.length > 0 || attendance.floor8.exited.length > 0 ? `<span class="text-sm font-normal text-green-600">- ${attendance.floor8.present.length}ëª… ìˆìŒ / ${attendance.floor8.exited.length}ëª… ë‚˜ê°</span>` : ''}</h2>
          
          ${renderSection('ğŸ”´ ë¯¸ì œì¶œ', data.floor8.notSubmitted, 'red', attendance.floor8, 8)}
          ${renderSection('ğŸŸ¡ ì œì¶œë‹¨ê³„ (í•™ë¶€ëª¨ ìŠ¹ì¸ ëŒ€ê¸°)', data.floor8.submitted, 'yellow', attendance.floor8, 8)}
          ${renderSection('ğŸ”µ í•™ë¶€ëª¨ ìŠ¹ì¸ì™„ë£Œ (ì‚¬ê° ìŠ¹ì¸ ëŒ€ê¸°)', data.floor8.parentApproved, 'blue', attendance.floor8, 8)}
          ${renderSection('ğŸŸ¢ ì‚¬ê° ìŠ¹ì¸ì™„ë£Œ', data.floor8.supervisorApproved, 'green', attendance.floor8, 8)}
        </div>

        <!-- 7ì¸µ -->
        <div class="bg-white rounded-xl p-4">
          <h2 class="text-lg font-bold mb-4">ğŸ¢ 7ì¸µ (ì´ ${roster.floor7.length}ëª…) ${attendance.floor7.present.length > 0 || attendance.floor7.exited.length > 0 ? `<span class="text-sm font-normal text-green-600">- ${attendance.floor7.present.length}ëª… ìˆìŒ / ${attendance.floor7.exited.length}ëª… ë‚˜ê°</span>` : ''}</h2>
          
          ${renderSection('ğŸ”´ ë¯¸ì œì¶œ', data.floor7.notSubmitted, 'red', attendance.floor7, 7)}
          ${renderSection('ğŸŸ¡ ì œì¶œë‹¨ê³„ (í•™ë¶€ëª¨ ìŠ¹ì¸ ëŒ€ê¸°)', data.floor7.submitted, 'yellow', attendance.floor7, 7)}
          ${renderSection('ğŸ”µ í•™ë¶€ëª¨ ìŠ¹ì¸ì™„ë£Œ (ì‚¬ê° ìŠ¹ì¸ ëŒ€ê¸°)', data.floor7.parentApproved, 'blue', attendance.floor7, 7)}
          ${renderSection('ğŸŸ¢ ì‚¬ê° ìŠ¹ì¸ì™„ë£Œ', data.floor7.supervisorApproved, 'green', attendance.floor7, 7)}
        </div>
      `;
    }

    function renderSection(title, names, color, floorAttendance, floor) {
      if (names.length === 0) return '';
      
      const colors = {
        red: 'bg-red-50 border-red-200 text-red-700 hover:bg-red-100',
        yellow: 'bg-yellow-50 border-yellow-200 text-yellow-700 hover:bg-yellow-100',
        blue: 'bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100',
        green: 'bg-green-50 border-green-200 text-green-700 hover:bg-green-100'
      };

      // ì¢Œì„ë²ˆí˜¸ ìˆœìœ¼ë¡œ ì •ë ¬ (ì§‘ì¤‘ì‹¤ì€ ë§¨ ë’¤ë¡œ)
      const sortedNames = [...names].sort((a, b) => {
        const seatA = getSeatNumber(a, floor);
        const seatB = getSeatNumber(b, floor);
        
        // ì§‘ì¤‘ì‹¤ ì²˜ë¦¬
        const isFocusA = seatA && seatA.toString().startsWith('ì§‘ì¤‘');
        const isFocusB = seatB && seatB.toString().startsWith('ì§‘ì¤‘');
        
        if (isFocusA && !isFocusB) return 1; // ì§‘ì¤‘ì‹¤ì€ ë’¤ë¡œ
        if (!isFocusA && isFocusB) return -1;
        if (isFocusA && isFocusB) {
          const numA = parseInt(seatA.toString().replace('ì§‘ì¤‘', '')) || 999;
          const numB = parseInt(seatB.toString().replace('ì§‘ì¤‘', '')) || 999;
          return numA - numB;
        }
        
        const numA = parseInt(seatA) || 999;
        const numB = parseInt(seatB) || 999;
        return numA - numB;
      });

      return `
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">${title} (${names.length}ëª…)</span>
            <button onclick='copyAll(${JSON.stringify(names)})' class="text-xs text-blue-500 hover:underline">ğŸ“‹ ì „ì²´ë³µì‚¬</button>
          </div>
          <div class="flex flex-wrap gap-2">
            ${sortedNames.map(name => {
              // ì´ë¦„ ë§¤ì¹­ (ìˆ«ì ì œê±°í•´ì„œë„ ë¹„êµ)
              const cleanName = name.replace(/[0-9]/g, '');
              const isPresent = floorAttendance.present.includes(name) || 
                                floorAttendance.present.includes(cleanName) ||
                                floorAttendance.present.some(n => n.replace(/[0-9]/g, '') === cleanName);
              const isExited = floorAttendance.exited.includes(name) || 
                               floorAttendance.exited.includes(cleanName) ||
                               floorAttendance.exited.some(n => n.replace(/[0-9]/g, '') === cleanName);
              const seatNum = getSeatNumber(name, floor);
              const isFocusRoom = seatNum && seatNum.toString().startsWith('ì§‘ì¤‘');
              const isFreeSeat = floor === 8 && freeSeatMap[name];
              let seatClass = 'seat-num';
              if (isFocusRoom) seatClass = 'seat-focus';
              else if (isFreeSeat) seatClass = 'seat-free';
              return `
              <span onclick="copyName('${name}')" class="px-3 py-1 rounded-lg border cursor-pointer text-sm ${colors[color]} ${isPresent ? 'present' : ''} ${copiedText === name ? 'ring-2 ring-blue-400' : ''}">
                ${seatNum ? `<span class="${seatClass}">[${seatNum}]</span>` : ''}${name}${isExited ? ' <span class="text-gray-400 text-xs">ë‚˜ê°</span>' : ''}${copiedText === name ? ' âœ“' : ''}
              </span>
            `}).join('')}
          </div>
        </div>
      `;
    }

    // ì´ˆê¸° ë¡œë“œ
    loadGoogleSheets();
  </script>
</body>
</html>
