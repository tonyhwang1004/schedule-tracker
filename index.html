<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì •ê¸°ì¼ì • ì œì¶œ í˜„í™©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-2">ğŸ“š ì •ê¸°ì¼ì • ì œì¶œ í˜„í™©</h1>
    <p class="text-center text-slate-500 text-sm mb-6">Google Sheets ì‹¤ì‹œê°„ ì—°ë™</p>

    <!-- ìƒíƒœë°” -->
    <div class="bg-white rounded-xl p-3 mb-4 flex flex-wrap items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <span id="status" class="text-sm text-slate-500">â³ ë¡œë”©ì¤‘...</span>
      </div>
      <button onclick="loadGoogleSheets()" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- ìˆ˜ëŠ¥ì„ ë°° ì—…ë¡œë“œ -->
    <label id="uploadBox" class="block p-4 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center mb-6 bg-white hover:border-blue-400">
      <div class="text-lg mb-1">ğŸ“ ìˆ˜ëŠ¥ì„ ë°°.xlsx ì—…ë¡œë“œ</div>
      <div class="text-sm text-slate-500">ì œì¶œ í˜„í™© íŒŒì¼</div>
      <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadSubmission(this)">
    </label>

    <!-- ê²°ê³¼ -->
    <div id="result"></div>
  </div>

  <script>
    // ì„¤ì •
    const SPREADSHEET_ID = '1OVEffnCRTZ1A-cVCb4CYiYe3MicyI9TSkJNsau4mGVo';
    const SHEET_GIDS = { floor7: '141026233', floor8: '1949498498' };

    // ë°ì´í„°
    let roster = { floor7: [], floor8: [] };
    let submission = { submitted: [], parentApproved: [], supervisorApproved: [] };
    let copiedText = '';

    // Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function loadGoogleSheets() {
      document.getElementById('status').textContent = 'â³ ë¡œë”©ì¤‘...';
      
      try {
        // 7ì¸µ ë°ì´í„°
        const res7 = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GIDS.floor7}`);
        const csv7 = await res7.text();
        roster.floor7 = parseNames(csv7);

        // 8ì¸µ ë°ì´í„°
        const res8 = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GIDS.floor8}`);
        const csv8 = await res8.text();
        roster.floor8 = parseNames(csv8);

        const now = new Date().toLocaleTimeString('ko-KR');
        document.getElementById('status').innerHTML = `âœ… 7ì¸µ ${roster.floor7.length}ëª…, 8ì¸µ ${roster.floor8.length}ëª… <span class="text-slate-400 text-xs">(${now})</span>`;
        
        render();
      } catch(e) {
        document.getElementById('status').textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
      }
    }

    // CSVì—ì„œ ì´ë¦„ë§Œ ì¶”ì¶œ (ì²« ë²ˆì§¸ ì»¬ëŸ¼)
    function parseNames(csv) {
      const lines = csv.split('\n');
      const names = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        // ì²« ë²ˆì§¸ ì»¬ëŸ¼ ì¶”ì¶œ (ë”°ì˜´í‘œ ì²˜ë¦¬)
        let name = '';
        if (line.startsWith('"')) {
          const endQuote = line.indexOf('"', 1);
          name = line.substring(1, endQuote);
        } else {
          name = line.split(',')[0];
        }
        
        name = name.trim();
        
        // ìœ íš¨í•œ ì´ë¦„ì¸ì§€ í™•ì¸ (í•œê¸€ 2-5ê¸€ì)
        if (name && /^[ê°€-í£]{2,5}$/.test(name)) {
          names.push(name);
        }
      }
      
      return names;
    }

    // ìˆ˜ëŠ¥ì„ ë°°.xlsx íŒŒì¼ ë¡œë“œ
    function loadSubmission(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        
        submission = { submitted: [], parentApproved: [], supervisorApproved: [] };
        
        data.forEach(row => {
          const name = row['ì´ë¦„']?.toString().trim();
          const status = row['ìŠ¹ì¸ìƒíƒœ']?.toString().trim();
          if (!name || !status) return;
          
          if (status === 'ì œì¶œ ë‹¨ê³„') submission.submitted.push(name);
          else if (status === 'í•™ë¶€ëª¨ ìŠ¹ì¸ ì™„ë£Œ') submission.parentApproved.push(name);
          else if (status === 'ì‚¬ê° ìŠ¹ì¸ ì™„ë£Œ') submission.supervisorApproved.push(name);
        });

        document.getElementById('uploadBox').className = 'block p-4 border-2 border-green-400 rounded-xl cursor-pointer text-center mb-6 bg-green-50';
        document.getElementById('uploadBox').innerHTML = `
          <div class="text-lg mb-1">âœ… ìˆ˜ëŠ¥ì„ ë°°.xlsx</div>
          <div class="text-sm text-slate-500">ì´ ${submission.submitted.length + submission.parentApproved.length + submission.supervisorApproved.length}ëª… ì œì¶œ</div>
          <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadSubmission(this)">
        `;
        
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    // ì´ë¦„ ë³µì‚¬
    function copyName(name) {
      navigator.clipboard.writeText(name);
      copiedText = name;
      render();
      setTimeout(() => { copiedText = ''; render(); }, 1500);
    }

    // ì „ì²´ ì´ë¦„ ë³µì‚¬
    function copyAll(names) {
      navigator.clipboard.writeText(names.join('\n'));
      alert(`${names.length}ëª… ì´ë¦„ ë³µì‚¬ ì™„ë£Œ!`);
    }

    // í™”ë©´ ë Œë”ë§
    function render() {
      const resultDiv = document.getElementById('result');
      
      if (roster.floor7.length === 0 && roster.floor8.length === 0) {
        resultDiv.innerHTML = '';
        return;
      }

      if (submission.submitted.length === 0 && submission.parentApproved.length === 0 && submission.supervisorApproved.length === 0) {
        resultDiv.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-slate-400">ìˆ˜ëŠ¥ì„ ë°°.xlsx íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>';
        return;
      }

      // ì œì¶œì ì „ì²´ ëª…ë‹¨
      const allSubmitted = new Set([...submission.submitted, ...submission.parentApproved, ...submission.supervisorApproved]);

      // ì¸µë³„ ë¶„ë¥˜
      const data = {
        floor8: {
          notSubmitted: roster.floor8.filter(n => !allSubmitted.has(n)),
          submitted: roster.floor8.filter(n => submission.submitted.includes(n)),
          parentApproved: roster.floor8.filter(n => submission.parentApproved.includes(n)),
          supervisorApproved: roster.floor8.filter(n => submission.supervisorApproved.includes(n))
        },
        floor7: {
          notSubmitted: roster.floor7.filter(n => !allSubmitted.has(n)),
          submitted: roster.floor7.filter(n => submission.submitted.includes(n)),
          parentApproved: roster.floor7.filter(n => submission.parentApproved.includes(n)),
          supervisorApproved: roster.floor7.filter(n => submission.supervisorApproved.includes(n))
        }
      };

      resultDiv.innerHTML = `
        <!-- 8ì¸µ -->
        <div class="bg-white rounded-xl p-4 mb-4">
          <h2 class="text-lg font-bold mb-4">ğŸ¢ 8ì¸µ (ì´ ${roster.floor8.length}ëª…)</h2>
          
          ${renderSection('ğŸ”´ ë¯¸ì œì¶œ', data.floor8.notSubmitted, 'red')}
          ${renderSection('ğŸŸ¡ ì œì¶œë‹¨ê³„ (í•™ë¶€ëª¨ ìŠ¹ì¸ ëŒ€ê¸°)', data.floor8.submitted, 'yellow')}
          ${renderSection('ğŸ”µ í•™ë¶€ëª¨ ìŠ¹ì¸ì™„ë£Œ (ì‚¬ê° ìŠ¹ì¸ ëŒ€ê¸°)', data.floor8.parentApproved, 'blue')}
          ${renderSection('ğŸŸ¢ ì‚¬ê° ìŠ¹ì¸ì™„ë£Œ', data.floor8.supervisorApproved, 'green')}
        </div>

        <!-- 7ì¸µ -->
        <div class="bg-white rounded-xl p-4">
          <h2 class="text-lg font-bold mb-4">ğŸ¢ 7ì¸µ (ì´ ${roster.floor7.length}ëª…)</h2>
          
          ${renderSection('ğŸ”´ ë¯¸ì œì¶œ', data.floor7.notSubmitted, 'red')}
          ${renderSection('ğŸŸ¡ ì œì¶œë‹¨ê³„ (í•™ë¶€ëª¨ ìŠ¹ì¸ ëŒ€ê¸°)', data.floor7.submitted, 'yellow')}
          ${renderSection('ğŸ”µ í•™ë¶€ëª¨ ìŠ¹ì¸ì™„ë£Œ (ì‚¬ê° ìŠ¹ì¸ ëŒ€ê¸°)', data.floor7.parentApproved, 'blue')}
          ${renderSection('ğŸŸ¢ ì‚¬ê° ìŠ¹ì¸ì™„ë£Œ', data.floor7.supervisorApproved, 'green')}
        </div>
      `;
    }

    function renderSection(title, names, color) {
      if (names.length === 0) return '';
      
      const colors = {
        red: 'bg-red-50 border-red-200 text-red-700 hover:bg-red-100',
        yellow: 'bg-yellow-50 border-yellow-200 text-yellow-700 hover:bg-yellow-100',
        blue: 'bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100',
        green: 'bg-green-50 border-green-200 text-green-700 hover:bg-green-100'
      };

      return `
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">${title} (${names.length}ëª…)</span>
            <button onclick='copyAll(${JSON.stringify(names)})' class="text-xs text-blue-500 hover:underline">ğŸ“‹ ì „ì²´ë³µì‚¬</button>
          </div>
          <div class="flex flex-wrap gap-2">
            ${names.map(name => `
              <span onclick="copyName('${name}')" class="px-3 py-1 rounded-lg border cursor-pointer text-sm ${colors[color]} ${copiedText === name ? 'ring-2 ring-blue-400' : ''}">
                ${name}${copiedText === name ? ' âœ“' : ''}
              </span>
            `).join('')}
          </div>
        </div>
      `;
    }

    // ì´ˆê¸° ë¡œë“œ
    loadGoogleSheets();
  </script>
</body>
</html>
