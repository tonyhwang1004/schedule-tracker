<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì •ê¸°ì¼ì • ì œì¶œ í˜„í™©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; }
    .present { box-shadow: 0 0 0 3px #22c55e; }
    .seat-num { font-size: 0.7rem; color: #6b7280; margin-right: 2px; }
    .seat-focus { font-size: 0.7rem; color: #8b5cf6; margin-right: 2px; font-weight: 600; }
    .seat-free { font-size: 0.7rem; color: #f97316; margin-right: 2px; font-weight: 600; }
    .loading { display: inline-block; width: 14px; height: 14px; border: 2px solid #f3f3f3; border-top: 2px solid #f97316; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-2">ğŸ“š ì •ê¸°ì¼ì • ì œì¶œ í˜„í™©</h1>
    <p class="text-center text-slate-500 text-sm mb-6">Google Sheets ì‹¤ì‹œê°„ ì—°ë™</p>

    <!-- ìƒíƒœë°” -->
    <div class="bg-white rounded-xl p-3 mb-4 flex flex-wrap items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <span id="status" class="text-sm text-slate-500">â³ ë¡œë”©ì¤‘...</span>
      </div>
      <button onclick="loadGoogleSheets()" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
      <!-- ìˆ˜ëŠ¥ì„ ë°° ì—…ë¡œë“œ -->
      <label id="uploadBox" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-blue-400">
        <div class="text-base mb-1">ğŸ“ ìˆ˜ëŠ¥ì„ ë°°</div>
        <div class="text-xs text-slate-500">ì œì¶œ í˜„í™©</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadSubmission(this)">
      </label>

      <!-- 8ì¸µ ì¶œì„ ì—…ë¡œë“œ -->
      <label id="upload8" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-green-400">
        <div class="text-base mb-1">ğŸ¢ 8ì¸µ ì¶œì„</div>
        <div class="text-xs text-slate-500">ì¶œì… ê¸°ë¡</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 8)">
      </label>

      <!-- 7ì¸µ ì¶œì„ ì—…ë¡œë“œ -->
      <label id="upload7" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-green-400">
        <div class="text-base mb-1">ğŸ¢ 7ì¸µ ì¶œì„</div>
        <div class="text-xs text-slate-500">ì¶œì… ê¸°ë¡</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 7)">
      </label>

      <!-- ì§‘ì¤‘ì‹¤ ì¢Œì„ ì—…ë¡œë“œ -->
      <label id="uploadFocus" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-purple-400">
        <div class="text-base mb-1">ğŸ¯ ì§‘ì¤‘ì‹¤</div>
        <div class="text-xs text-slate-500">ì¢Œì„ ë°°ì¹˜</div>
        <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadFocusRoom(this)">
      </label>
    </div>

    <!-- ììœ ì„ ì¢Œì„ ì—…ë¡œë“œ (PDF) -->
    <div class="mb-6">
      <label id="uploadFree" class="block p-3 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer text-center bg-white hover:border-orange-400">
        <div class="text-base mb-1">ğŸª‘ ììœ ì„ ë°°ì¹˜</div>
        <div class="text-xs text-slate-500">PDF ì—…ë¡œë“œ (ìë™ ë¶„ì„)</div>
        <input type="file" accept=".pdf" class="hidden" onchange="loadFreeSeatPDF(this)">
      </label>
      <div id="freeSeatStatus" class="mt-2 text-sm text-center"></div>
      <div id="freeSeatResult" class="mt-2"></div>
    </div>

    <!-- ë²”ë¡€ -->
    <div class="flex flex-wrap items-center gap-4 mb-4 text-sm text-slate-600">
      <span class="flex items-center gap-1"><span class="w-4 h-4 rounded border-2 border-green-500 bg-green-100"></span> í˜„ì¬ ìˆìŒ</span>
      <span class="flex items-center gap-1"><span class="text-gray-400 text-xs">ë‚˜ê°</span> = í‡´ì‹¤</span>
      <span class="flex items-center gap-1"><span class="text-gray-500 text-xs">[ë²ˆí˜¸]</span> = ì§€ì •ì„</span>
      <span class="flex items-center gap-1"><span class="text-orange-500 text-xs font-bold">[ë²ˆí˜¸]</span> = ììœ ì„</span>
      <span class="flex items-center gap-1"><span class="text-purple-500 text-xs font-bold">[ì§‘ì¤‘N]</span> = ì§‘ì¤‘ì‹¤</span>
    </div>

    <!-- ê²°ê³¼ -->
    <div id="result"></div>
  </div>

  <script>
    // ì„¤ì •
    const SPREADSHEET_ID = '1OVEffnCRTZ1A-cVCb4CYiYe3MicyI9TSkJNsau4mGVo';
    const SHEET_GIDS = { floor7: '141026233', floor8: '910829726' };

    // ë°ì´í„°
    let roster = { floor7: [], floor8: [] };
    let seatMap = { floor7: {}, floor8: {} }; // Google Sheetsì—ì„œ ë¡œë“œ
    let focusRoomSeats = {}; // ì§‘ì¤‘ì‹¤ ì¢Œì„ (ì—‘ì…€ì—ì„œ ë¡œë“œ)
    let freeSeatMap = {}; // ììœ ì„ ì¢Œì„ (PDF ë¶„ì„ ë°ì´í„°)
    let freeSeatImage = null; // ììœ ì„ ì´ë¯¸ì§€
    let submission = { submitted: [], parentApproved: [], supervisorApproved: [] };
    let attendance = { floor7: { present: [], exited: [] }, floor8: { present: [], exited: [] } };
    let copiedText = '';

    // ììœ ì„ ì´ˆê¸° ë°ì´í„° (PDF ì—…ë¡œë“œ ì‹œ ìë™ ë¶„ì„ë¨)
    freeSeatMap = {};

    // ì¢Œì„ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    function getSeatNumber(name, floor) {
      // ì§‘ì¤‘ì‹¤ ë¨¼ì € ì²´í¬ (ì—‘ì…€ì—ì„œ ë¡œë“œëœ ë°ì´í„°ë§Œ)
      if (focusRoomSeats[name]) {
        return 'ì§‘ì¤‘' + focusRoomSeats[name];
      }
      // ììœ ì„ ì²´í¬ (8ì¸µ, ì—‘ì…€ì—ì„œ ë¡œë“œëœ ë°ì´í„°)
      if (floor === 8 && freeSeatMap[name]) {
        return freeSeatMap[name];
      }
      // Google Sheets ë°ì´í„° (ì§€ì •ì„ë§Œ)
      const map = floor === 7 ? seatMap.floor7 : seatMap.floor8;
      const seatNum = map[name];
      
      // ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ í•„í„°ë§
      if (!seatNum) return null;
      
      // ìˆ«ìê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ (ì§‘ì¤‘ì‹¤ ì „í™”ë²ˆí˜¸ ë“± ë¬¸ìì—´)
      if (typeof seatNum !== 'number') return null;
      
      // 100 ì´ˆê³¼ëŠ” ë¬´ì‹œ (ì˜ëª»ëœ ê°’)
      if (seatNum > 100) return null;
      
      return seatNum;
    }

    // ì§‘ì¤‘ì‹¤ ì—‘ì…€ ë¡œë“œ - ê°„ë‹¨í•œ ë²ˆí˜¸ë¡œ í‘œì‹œ
    function loadFocusRoom(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
        
        focusRoomSeats = {};
        
        // í—¤ë” ìŠ¤í‚µí•˜ê³  ë°ì´í„° íŒŒì‹±
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (!row || row.length < 2) continue;
          
          // Aì—´: ì´ë¦„, Bì—´: ì¢Œì„ë²ˆí˜¸
          const name = (row[0] || '').toString().trim();
          const seat = (row[1] || '').toString().trim();
          
          if (name && /^[ê°€-í£]{2,4}$/.test(name) && seat) {
            const seatNum = seat.match(/\d+/);
            if (seatNum) {
              // ê°„ë‹¨í•˜ê²Œ 1, 2, 3... ìœ¼ë¡œ ì €ì¥
              focusRoomSeats[name] = parseInt(seatNum[0]);
            }
          }
        }

        const count = Object.keys(focusRoomSeats).length;
        document.getElementById('uploadFocus').className = 'block p-3 border-2 border-purple-400 rounded-xl cursor-pointer text-center bg-purple-50';
        document.getElementById('uploadFocus').innerHTML = `
          <div class="text-base mb-1">âœ… ì§‘ì¤‘ì‹¤</div>
          <div class="text-xs text-purple-600">${count}ëª… ë°°ì¹˜</div>
          <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadFocusRoom(this)">
        `;
        
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    // ììœ ì„ PDF ë¶„ì„
    async function loadFreeSeatPDF(input) {
      const file = input.files[0];
      if (!file) return;

      const statusEl = document.getElementById('freeSeatStatus');
      statusEl.innerHTML = '<span class="loading"></span> PDF ë¶„ì„ ì¤‘...';

      try {
        const arrayBuffer = await file.arrayBuffer();
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        
        freeSeatMap = {};
        
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();
          
          // í…ìŠ¤íŠ¸ì™€ ì¢Œí‘œ ì¶”ì¶œ
          const items = [];
          textContent.items.forEach(item => {
            const text = item.str.trim();
            if (text) {
              items.push({
                text: text,
                x: Math.round(item.transform[4]),
                y: Math.round(item.transform[5])
              });
            }
          });
          
          // ì¸ì ‘í•œ í…ìŠ¤íŠ¸ í•©ì¹˜ê¸° (ë°•ì •ì› + 2 â†’ ë°•ì •ì›2)
          const mergedItems = [];
          const used = new Set();
          
          items.forEach((item, i) => {
            if (used.has(i)) return;
            
            let combined = item.text;
            items.forEach((other, j) => {
              if (i !== j && !used.has(j)) {
                // ê°™ì€ Yì¢Œí‘œ (Â±3), Xê°€ ë°”ë¡œ ì˜¤ë¥¸ìª½ (5~25 ì°¨ì´)
                if (Math.abs(item.y - other.y) <= 3) {
                  const xDiff = other.x - item.x;
                  if (xDiff > 5 && xDiff < 30 && /^\d+$/.test(other.text)) {
                    combined += other.text;
                    used.add(j);
                  }
                }
              }
            });
            
            mergedItems.push({ text: combined, x: item.x, y: item.y });
            used.add(i);
          });
          
          // ìˆ«ì(ì¢Œì„ë²ˆí˜¸ 57-104)ì™€ ì´ë¦„ ë¶„ë¦¬
          const numbers = mergedItems.filter(item => {
            if (/^\d{2,3}$/.test(item.text)) {
              const num = parseInt(item.text);
              return num >= 57 && num <= 104;
            }
            return false;
          });
          
          const names = mergedItems.filter(item => 
            /^[ê°€-í£]{2,4}\d*$/.test(item.text) && item.text !== 'ì…êµ¬'
          );
          
          console.log('ìˆ«ì:', numbers.map(n => `${n.text}(${n.x},${n.y})`));
          console.log('ì´ë¦„:', names.map(n => `${n.text}(${n.x},${n.y})`));
          
          // ë§¤ì¹­: ê° ì´ë¦„ì— ëŒ€í•´ ë°”ë¡œ ìœ„ì— ìˆëŠ” ìˆ«ì ì°¾ê¸°
          names.forEach(nameItem => {
            let bestMatch = null;
            let minDistance = Infinity;
            
            numbers.forEach(numItem => {
              // ìˆ«ìê°€ ì´ë¦„ ìœ„ì— ìˆì–´ì•¼ í•¨ (ìˆ«ì Y < ì´ë¦„ Y, PDF ì¢Œí‘œê³„)
              const yDiff = nameItem.y - numItem.y;
              const xDiff = Math.abs(nameItem.x - numItem.x);
              
              // ì¡°ê±´ í™•ëŒ€: Yì°¨ì´ 5~30, Xì°¨ì´ 20 ì´ë‚´
              if (yDiff > 0 && yDiff < 30 && xDiff < 20) {
                const distance = xDiff + yDiff;
                if (distance < minDistance) {
                  minDistance = distance;
                  bestMatch = numItem;
                }
              }
            });
            
            if (bestMatch) {
              freeSeatMap[nameItem.text] = parseInt(bestMatch.text);
              console.log(`âœ… ë§¤ì¹­: [${bestMatch.text}] ${nameItem.text}`);
            } else {
              console.log(`âŒ ë§¤ì¹­ ì‹¤íŒ¨: ${nameItem.text} (x:${nameItem.x}, y:${nameItem.y})`);
            }
          });
        }

        const count = Object.keys(freeSeatMap).length;
        
        if (count > 0) {
          document.getElementById('uploadFree').className = 'block p-3 border-2 border-orange-400 rounded-xl cursor-pointer text-center bg-orange-50';
          document.getElementById('uploadFree').innerHTML = `
            <div class="text-base mb-1">âœ… ììœ ì„ ë°°ì¹˜</div>
            <div class="text-xs text-orange-600">${count}ëª… ë¶„ì„ ì™„ë£Œ</div>
            <input type="file" accept=".pdf" class="hidden" onchange="loadFreeSeatPDF(this)">
          `;
          
          statusEl.innerHTML = `<span class="text-green-600">âœ… ${count}ëª… ì¢Œì„ ë¶„ì„ ì™„ë£Œ!</span>`;
          
          // ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
          document.getElementById('freeSeatResult').innerHTML = `
            <div class="bg-orange-50 rounded-lg p-3 text-sm">
              <div class="font-bold mb-2 text-orange-700">ğŸª‘ ììœ ì„ (${count}ëª…)</div>
              <div class="flex flex-wrap gap-2">
                ${Object.entries(freeSeatMap).sort((a,b) => a[1] - b[1]).map(([name, seat]) => 
                  `<span class="px-2 py-1 bg-white rounded border text-xs">[${seat}] ${name}</span>`
                ).join('')}
              </div>
            </div>
          `;
          
          render();
        } else {
          statusEl.innerHTML = '<span class="text-red-500">âŒ ì¢Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
        }
        
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="text-red-500">âŒ ë¶„ì„ ì‹¤íŒ¨: ${err.message}</span>`;
      }
    }

    // Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì´ë¦„ + ì¢Œì„ë²ˆí˜¸)
    async function loadGoogleSheets() {
      document.getElementById('status').textContent = 'â³ ë¡œë”©ì¤‘...';
      
      try {
        // 7ì¸µ ë°ì´í„°
        const res7 = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GIDS.floor7}`);
        const csv7 = await res7.text();
        const data7 = parseNamesAndSeats(csv7);
        roster.floor7 = data7.names;
        seatMap.floor7 = data7.seats;

        // 8ì¸µ ë°ì´í„°
        const res8 = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GIDS.floor8}`);
        const csv8 = await res8.text();
        const data8 = parseNamesAndSeats(csv8);
        roster.floor8 = data8.names;
        seatMap.floor8 = data8.seats;

        const now = new Date().toLocaleTimeString('ko-KR');
        document.getElementById('status').innerHTML = `âœ… 7ì¸µ ${roster.floor7.length}ëª…, 8ì¸µ ${roster.floor8.length}ëª… <span class="text-slate-400 text-xs">(${now})</span>`;
        
        render();
      } catch(e) {
        document.getElementById('status').textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
      }
    }

    // CSVì—ì„œ ì´ë¦„(Aì—´)ê³¼ ì¢Œì„ë²ˆí˜¸(Eì—´) ì¶”ì¶œ
    function parseNamesAndSeats(csv) {
      const lines = csv.split('\n');
      const names = [];
      const seats = {};
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        // CSV íŒŒì‹±
        const cols = parseCSVRow(line);
        const name = (cols[0] || '').replace(/"/g, '').trim();
        const seatRaw = (cols[4] || '').replace(/"/g, '').trim(); // Eì—´ (ì¸ë±ìŠ¤ 4)
        
        // ìœ íš¨í•œ ì´ë¦„ì¸ì§€ í™•ì¸
        if (name && /^[ê°€-í£]{2,4}$/.test(name) && !name.includes('í•™ìƒ') && !name.includes('ì´ë¦„')) {
          names.push(name);
          
          // ì¢Œì„ë²ˆí˜¸ ì¶”ì¶œ - ì§€ì •ì„ë§Œ (ì§‘ì¤‘ì‹¤, ììœ ì„ ì œì™¸)
          // "ì§‘ì¤‘"ìœ¼ë¡œ ì‹œì‘í•˜ë©´ ë¬´ì‹œ (ì§‘ì¤‘ì‹¤ì€ ë³„ë„ ì—‘ì…€ë¡œ ê´€ë¦¬)
          if (seatRaw.startsWith('ì§‘ì¤‘')) {
            // ì§‘ì¤‘ì‹¤ì€ ë¬´ì‹œ - ë³„ë„ ì—‘ì…€ ì—…ë¡œë“œë¡œ ê´€ë¦¬
            continue;
          }
          
          const seatMatch = seatRaw.match(/^(\d+)/);
          if (seatMatch) {
            const seatNum = parseInt(seatMatch[1]);
            // 8ì¸µ ì§€ì •ì„(1-56)ë§Œ ì €ì¥, ììœ ì„(57+)ì€ PDFì—ì„œ ê°€ì ¸ì˜´
            if (seatNum >= 1 && seatNum <= 56) {
              seats[name] = seatNum;
            }
          }
        }
      }
      
      return { names, seats };
    }

    // CSV í–‰ íŒŒì‹± (ë”°ì˜´í‘œ ì²˜ë¦¬)
    function parseCSVRow(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // ìˆ˜ëŠ¥ì„ ë°°.xlsx íŒŒì¼ ë¡œë“œ
    function loadSubmission(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        
        submission = { submitted: [], parentApproved: [], supervisorApproved: [] };
        
        data.forEach(row => {
          const name = row['ì´ë¦„']?.toString().trim();
          const status = row['ìŠ¹ì¸ìƒíƒœ']?.toString().trim();
          if (!name || !status) return;
          
          if (status === 'ì œì¶œ ë‹¨ê³„') submission.submitted.push(name);
          else if (status === 'í•™ë¶€ëª¨ ìŠ¹ì¸ ì™„ë£Œ') submission.parentApproved.push(name);
          else if (status === 'ì‚¬ê° ìŠ¹ì¸ ì™„ë£Œ') submission.supervisorApproved.push(name);
        });

        document.getElementById('uploadBox').className = 'block p-3 border-2 border-green-400 rounded-xl cursor-pointer text-center bg-green-50';
        document.getElementById('uploadBox').innerHTML = `
          <div class="text-base mb-1">âœ… ìˆ˜ëŠ¥ì„ ë°°.xlsx</div>
          <div class="text-xs text-slate-500">${submission.submitted.length + submission.parentApproved.length + submission.supervisorApproved.length}ëª… ì œì¶œ</div>
          <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadSubmission(this)">
        `;
        
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    // ì¶œì„ íŒŒì¼ ë¡œë“œ
    function loadAttendance(input, floor) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        
        const lastRecord = {};
        data.forEach(row => {
          const name = row['ì´ë¦„']?.toString().trim();
          const direction = row['ë°©í–¥']?.toString().trim();
          if (name && direction && !lastRecord[name]) {
            lastRecord[name] = direction;
          }
        });
        
        const presentStudents = Object.keys(lastRecord).filter(name => lastRecord[name] === 'ENTER');
        const exitedStudents = Object.keys(lastRecord).filter(name => lastRecord[name] === 'EXIT');
        
        if (floor === 7) {
          attendance.floor7 = { present: presentStudents, exited: exitedStudents };
          document.getElementById('upload7').className = 'block p-3 border-2 border-green-400 rounded-xl cursor-pointer text-center bg-green-50';
          document.getElementById('upload7').innerHTML = `
            <div class="text-base mb-1">âœ… 7ì¸µ ì¶œì„</div>
            <div class="text-xs text-slate-500">${presentStudents.length}ëª… ìˆìŒ / ${exitedStudents.length}ëª… ë‚˜ê°</div>
            <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 7)">
          `;
        } else {
          attendance.floor8 = { present: presentStudents, exited: exitedStudents };
          document.getElementById('upload8').className = 'block p-3 border-2 border-green-400 rounded-xl cursor-pointer text-center bg-green-50';
          document.getElementById('upload8').innerHTML = `
            <div class="text-base mb-1">âœ… 8ì¸µ ì¶œì„</div>
            <div class="text-xs text-slate-500">${presentStudents.length}ëª… ìˆìŒ / ${exitedStudents.length}ëª… ë‚˜ê°</div>
            <input type="file" accept=".xlsx,.xls" class="hidden" onchange="loadAttendance(this, 8)">
          `;
        }
        
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    // ì´ë¦„ ë³µì‚¬
    function copyName(name) {
      navigator.clipboard.writeText(name);
      copiedText = name;
      render();
      setTimeout(() => { copiedText = ''; render(); }, 1500);
    }

    // ì „ì²´ ì´ë¦„ ë³µì‚¬
    function copyAll(names) {
      navigator.clipboard.writeText(names.join('\n'));
      alert(`${names.length}ëª… ì´ë¦„ ë³µì‚¬ ì™„ë£Œ!`);
    }

    // í™”ë©´ ë Œë”ë§
    function render() {
      const resultDiv = document.getElementById('result');
      
      if (roster.floor7.length === 0 && roster.floor8.length === 0) {
        resultDiv.innerHTML = '';
        return;
      }

      if (submission.submitted.length === 0 && submission.parentApproved.length === 0 && submission.supervisorApproved.length === 0) {
        resultDiv.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-slate-400">ìˆ˜ëŠ¥ì„ ë°°.xlsx íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>';
        return;
      }

      const allSubmitted = new Set([...submission.submitted, ...submission.parentApproved, ...submission.supervisorApproved]);

      const data = {
        floor8: {
          notSubmitted: roster.floor8.filter(n => !allSubmitted.has(n)),
          submitted: roster.floor8.filter(n => submission.submitted.includes(n)),
          parentApproved: roster.floor8.filter(n => submission.parentApproved.includes(n)),
          supervisorApproved: roster.floor8.filter(n => submission.supervisorApproved.includes(n))
        },
        floor7: {
          notSubmitted: roster.floor7.filter(n => !allSubmitted.has(n)),
          submitted: roster.floor7.filter(n => submission.submitted.includes(n)),
          parentApproved: roster.floor7.filter(n => submission.parentApproved.includes(n)),
          supervisorApproved: roster.floor7.filter(n => submission.supervisorApproved.includes(n))
        }
      };

      resultDiv.innerHTML = `
        <!-- 8ì¸µ -->
        <div class="bg-white rounded-xl p-4 mb-4">
          <h2 class="text-lg font-bold mb-4">ğŸ¢ 8ì¸µ (ì´ ${roster.floor8.length}ëª…) ${attendance.floor8.present.length > 0 || attendance.floor8.exited.length > 0 ? `<span class="text-sm font-normal text-green-600">- ${attendance.floor8.present.length}ëª… ìˆìŒ / ${attendance.floor8.exited.length}ëª… ë‚˜ê°</span>` : ''}</h2>
          
          ${renderSection('ğŸ”´ ë¯¸ì œì¶œ', data.floor8.notSubmitted, 'red', attendance.floor8, 8)}
          ${renderSection('ğŸŸ¡ ì œì¶œë‹¨ê³„ (í•™ë¶€ëª¨ ìŠ¹ì¸ ëŒ€ê¸°)', data.floor8.submitted, 'yellow', attendance.floor8, 8)}
          ${renderSection('ğŸ”µ í•™ë¶€ëª¨ ìŠ¹ì¸ì™„ë£Œ (ì‚¬ê° ìŠ¹ì¸ ëŒ€ê¸°)', data.floor8.parentApproved, 'blue', attendance.floor8, 8)}
          ${renderSection('ğŸŸ¢ ì‚¬ê° ìŠ¹ì¸ì™„ë£Œ', data.floor8.supervisorApproved, 'green', attendance.floor8, 8)}
        </div>

        <!-- 7ì¸µ -->
        <div class="bg-white rounded-xl p-4">
          <h2 class="text-lg font-bold mb-4">ğŸ¢ 7ì¸µ (ì´ ${roster.floor7.length}ëª…) ${attendance.floor7.present.length > 0 || attendance.floor7.exited.length > 0 ? `<span class="text-sm font-normal text-green-600">- ${attendance.floor7.present.length}ëª… ìˆìŒ / ${attendance.floor7.exited.length}ëª… ë‚˜ê°</span>` : ''}</h2>
          
          ${renderSection('ğŸ”´ ë¯¸ì œì¶œ', data.floor7.notSubmitted, 'red', attendance.floor7, 7)}
          ${renderSection('ğŸŸ¡ ì œì¶œë‹¨ê³„ (í•™ë¶€ëª¨ ìŠ¹ì¸ ëŒ€ê¸°)', data.floor7.submitted, 'yellow', attendance.floor7, 7)}
          ${renderSection('ğŸ”µ í•™ë¶€ëª¨ ìŠ¹ì¸ì™„ë£Œ (ì‚¬ê° ìŠ¹ì¸ ëŒ€ê¸°)', data.floor7.parentApproved, 'blue', attendance.floor7, 7)}
          ${renderSection('ğŸŸ¢ ì‚¬ê° ìŠ¹ì¸ì™„ë£Œ', data.floor7.supervisorApproved, 'green', attendance.floor7, 7)}
        </div>
      `;
    }

    function renderSection(title, names, color, floorAttendance, floor) {
      if (names.length === 0) return '';
      
      const colors = {
        red: 'bg-red-50 border-red-200 text-red-700 hover:bg-red-100',
        yellow: 'bg-yellow-50 border-yellow-200 text-yellow-700 hover:bg-yellow-100',
        blue: 'bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100',
        green: 'bg-green-50 border-green-200 text-green-700 hover:bg-green-100'
      };

      // ì¢Œì„ë²ˆí˜¸ ìˆœìœ¼ë¡œ ì •ë ¬ (ì§‘ì¤‘ì‹¤ì€ ë§¨ ë’¤ë¡œ)
      const sortedNames = [...names].sort((a, b) => {
        const seatA = getSeatNumber(a, floor);
        const seatB = getSeatNumber(b, floor);
        
        // ì§‘ì¤‘ì‹¤ ì²˜ë¦¬
        const isFocusA = seatA && seatA.toString().startsWith('ì§‘ì¤‘');
        const isFocusB = seatB && seatB.toString().startsWith('ì§‘ì¤‘');
        
        if (isFocusA && !isFocusB) return 1; // ì§‘ì¤‘ì‹¤ì€ ë’¤ë¡œ
        if (!isFocusA && isFocusB) return -1;
        if (isFocusA && isFocusB) {
          const numA = parseInt(seatA.toString().replace('ì§‘ì¤‘', '')) || 999;
          const numB = parseInt(seatB.toString().replace('ì§‘ì¤‘', '')) || 999;
          return numA - numB;
        }
        
        const numA = parseInt(seatA) || 999;
        const numB = parseInt(seatB) || 999;
        return numA - numB;
      });

      return `
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">${title} (${names.length}ëª…)</span>
            <button onclick='copyAll(${JSON.stringify(names)})' class="text-xs text-blue-500 hover:underline">ğŸ“‹ ì „ì²´ë³µì‚¬</button>
          </div>
          <div class="flex flex-wrap gap-2">
            ${sortedNames.map(name => {
              // ì´ë¦„ ë§¤ì¹­ (ìˆ«ì ì œê±°í•´ì„œë„ ë¹„êµ)
              const cleanName = name.replace(/[0-9]/g, '');
              const isPresent = floorAttendance.present.includes(name) || 
                                floorAttendance.present.includes(cleanName) ||
                                floorAttendance.present.some(n => n.replace(/[0-9]/g, '') === cleanName);
              const isExited = floorAttendance.exited.includes(name) || 
                               floorAttendance.exited.includes(cleanName) ||
                               floorAttendance.exited.some(n => n.replace(/[0-9]/g, '') === cleanName);
              const seatNum = getSeatNumber(name, floor);
              const isFocusRoom = seatNum && seatNum.toString().startsWith('ì§‘ì¤‘');
              const isFreeSeat = floor === 8 && freeSeatMap[name];
              let seatClass = 'seat-num';
              if (isFocusRoom) seatClass = 'seat-focus';
              else if (isFreeSeat) seatClass = 'seat-free';
              return `
              <span onclick="copyName('${name}')" class="px-3 py-1 rounded-lg border cursor-pointer text-sm ${colors[color]} ${isPresent ? 'present' : ''} ${copiedText === name ? 'ring-2 ring-blue-400' : ''}">
                ${seatNum ? `<span class="${seatClass}">[${seatNum}]</span>` : ''}${name}${isExited ? ' <span class="text-gray-400 text-xs">ë‚˜ê°</span>' : ''}${copiedText === name ? ' âœ“' : ''}
              </span>
            `}).join('')}
          </div>
        </div>
      `;
    }

    // ì´ˆê¸° ë¡œë“œ
    loadGoogleSheets();
  </script>
</body>
</html>
